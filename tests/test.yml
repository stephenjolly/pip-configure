---
- hosts: servers:pip_configure_host_1
  connection: local
  vars_files:
    - vars/all.yml
  vars:
    pipconfig_dir: "{{ secure_base_dir }}/.pip"
  pre_tasks:
    - name: "Create base directory"
      file:
        path: "{{ insecure_base_dir }}"
        mode: "0770"
        state: directory
    - name: "Set find link urls patterns"
      set_fact:
        link_patterns: "{{link_patterns|default([]) + [{'line': '        ' + item, 'pattern': '\\s{8}' + item}] }}"
      with_items:
         - "{{ links }}"
    - name: "Set extra index urls patterns"
      set_fact:
        extra_patterns: "{{extra_patterns|default([]) + [{'line': '        ' + item, 'pattern': '\\s{8}' + item}] }}"
      with_items:
         - "{{ extras }}"
  roles:
    - role: "pip-configure"
      pipconfig_find_links_urls: "{{ links }}"
      pipconfig_extra_index_urls: "{{ extras }}"

  tasks:
    - name: "Get file stats"
      stat:
        path: "{{pipconfig_dir}}/{{ pipconfig_file }}"
      register: config_file_check

    - name: "Get dir stats"
      stat:
        path: "{{ pipconfig_dir}}"
      register: config_dir_check

    - name:
      debug:
        msg: "Actual: {{ config_dir_check.stat.mode }} expected: {{pipconfig_dir_mode}}"

    - name: "Assert '{{pipconfig_dir}}' exists and has the correct mode"
      assert:
        that:
          - 'config_dir_check|success'
          - 'config_dir_check.stat.mode == pipconfig_dir_mode'

    - name: "Assert '{{pipconfig_dir}}/{{pipconfig_file}}' exists and has the correct mode"
      assert:
        that:
          - "config_file_check|success"
          - "config_file_check.stat.mode == pipconfig_file_mode"

    - name: "Assert '{{pipconfig_file}}' contains find-url and url."
      lineinfile:
        path: "{{pipconfig_dir}}/{{ pipconfig_file }}"
        line: "{{item.line}}"
        regexp: "{{ item.pattern |default(item.line) }}"
        state: present
      with_items: "{{ [{'line': 'find-links =' }] + link_patterns }}"
      register: findurl_lines_in_file_check
      failed_when: "findurl_lines_in_file_check.changed"

    - name: "Assert '{{pipconfig_file}}' contains extra-index-url and url."
      lineinfile:
        path: "{{ pipconfig_dir }}/{{ pipconfig_file }}"
        line: "{{ item.line }}"
        regexp: "{{ item.pattern |default(item.line) }}"
        state: present
      with_items: "{{ [{'line': 'extra-index-url =' }] + extra_patterns }}"
      register: findurl_lines_in_file_check
      failed_when: "findurl_lines_in_file_check.changed"


# vim: et:sw=2:syntax=yaml:ts=2:
